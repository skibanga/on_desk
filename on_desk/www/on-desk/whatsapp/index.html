{% extends "templates/web.html" %}

{% block head_include %}
<!-- Include socket.io client library -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
{% endblock %}

{% block page_content %}
<div class="container">
    <div class="whatsapp-grid">
        <!-- Conversations List -->
        <div class="whatsapp-card">
            <div class="card-header">
                <h5>Conversations</h5>
                <div class="whatsapp-header-actions">
                    <button id="refresh-conversations-btn" class="btn-icon" title="Refresh Conversations">
                        <i class="uil uil-refresh"></i>
                    </button>
                    <button id="new-conversation-btn" class="btn-icon" title="New Conversation">
                        <i class="uil uil-plus"></i>
                    </button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search conversations...">
            </div>
            <div class="card-body">
                <ul class="conversation-list">
                    {% if conversations %}
                    {% for conversation in conversations %}
                    <li class="conversation-item {% if active_conversation and active_conversation.phone == conversation.phone %}active{% endif %}" data-phone="{{ conversation.phone }}" data-name="{{ conversation.name }}">
                        <div class="conversation-avatar">
                            {{ conversation.name.0 }}
                            {% if conversation.status == "Online" %}
                            <div class="online-indicator"></div>
                            {% endif %}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">{{ conversation.name }}</div>
                            <div class="conversation-preview">{{ conversation.last_message }}</div>
                        </div>
                        <div class="conversation-meta">
                            <div class="conversation-time">{{ conversation.time }}</div>
                            {% if conversation.unread %}
                            <div class="unread-badge">{{ conversation.unread }}</div>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <div class="text-center p-3">
                        <p class="text-muted">No conversations yet</p>
                        <button class="btn btn-sm btn-primary" id="new-conversation-btn">
                            <i class="uil uil-plus"></i> New Conversation
                        </button>
                    </div>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="whatsapp-card">
            <div class="chat-container">
                <div class="chat-header">
                    <button id="back-to-conversations-btn" class="btn-icon d-md-none" title="Back to Conversations">
                        <i class="uil uil-arrow-left"></i>
                    </button>
                    <div class="chat-avatar">
                        {% if active_conversation %}
                        {{ active_conversation.name.0 }}
                        {% endif %}
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">
                            {% if active_conversation %}
                            {{ active_conversation.name }}
                            {% else %}
                            Select a conversation
                            {% endif %}
                        </div>
                        <div class="chat-status">
                            {% if active_conversation %}
                            Online
                            {% endif %}
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="Refresh">
                            <i class="uil uil-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    {% if messages %}
                    <div class="date-divider">Today</div>
                    {% for message in messages %}
                    <div class="message {% if message.direction == 'Incoming' %}message-incoming{% else %}message-outgoing{% endif %}" data-message-id="{{ message.message_id }}">
                        {{ message.message }}
                        <div class="message-time">{{ message.time }}</div>
                        {% if message.direction == 'Outgoing' %}
                        <div class="message-status">
                            <span>{{ message.status }}</span>
                            {% if message.status == 'Sent' %}
                            <i class="uil uil-check status-icon status-sent"></i>
                            {% elif message.status == 'Delivered' %}
                            <i class="uil uil-check-double status-icon status-delivered"></i>
                            {% elif message.status == 'Read' %}
                            <i class="uil uil-check-double status-icon status-read"></i>
                            {% elif message.status == 'Failed' %}
                            <i class="uil uil-times status-icon status-failed"></i>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="uil uil-comment-alt-message"></i>
                        </div>
                        <div class="empty-state-title">No messages yet</div>
                        <div class="empty-state-text">Start the conversation by sending a message</div>
                    </div>
                    {% endif %}
                </div>
                <div class="chat-input">
                    <div class="chat-input-container">
                        <input type="text" id="message-input" placeholder="Type a message..." {% if not active_conversation %}disabled{% endif %}>
                        <div class="chat-input-actions">
                            <button class="chat-input-action" title="Emoji">
                                <i class="uil uil-smile"></i>
                            </button>
                            <button class="chat-input-action" title="Attach">
                                <i class="uil uil-paperclip"></i>
                            </button>
                        </div>
                    </div>
                    <button id="send-message-btn" {% if not active_conversation %}disabled{% endif %}>
                        <i class="uil uil-message"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* WhatsApp Integration */
    .whatsapp-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    @media (max-width: 768px) {
        .whatsapp-grid {
            grid-template-columns: 1fr;
        }

        .whatsapp-grid.show-chat .whatsapp-card:first-child {
            display: none;
        }
    }

    /* Add more styles as needed */
</style>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Set up socket.io connection
        setupSocketConnection();

        // Initialize WhatsApp UI
        initializeWhatsAppUI();

        // Function to set up socket.io connection
        function setupSocketConnection() {
            console.log("Setting up socket.io connection...");

            // Check if socket.io is available
            if (typeof io === 'undefined') {
                console.error("Socket.io not found. Make sure socket.io.min.js is included.");
                return;
            }

            try {
                // Get the socket.io port
                const socketioPort = {{ socketio_port }};

                // Get the site name from the URL
                const siteName = window.location.pathname.split('/')[1] || '';

                // Determine the protocol (http or https)
                const protocol = window.location.protocol === 'https:' ? 'https://' : 'http://';

                // Create the socket.io URL
                const socketUrl = protocol + window.location.hostname + ':' + socketioPort + (siteName ? '/' + siteName : '');
                console.log("Connecting to socket.io at:", socketUrl);

                // Create the socket.io connection
                const socket = io(socketUrl, {
                    withCredentials: true,
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    reconnectionAttempts: Infinity,
                    transports: ['websocket', 'polling']
                });

                // Connection events
                socket.on('connect', function() {
                    console.log("Socket.io connected successfully");

                    // Listen for WhatsApp events
                    socket.on('whatsapp_message_received', function(data) {
                        console.log("WhatsApp message received via socket.io:", data);
                        processWhatsAppMessage(data);
                    });

                    // Also listen for immediate events
                    socket.on('whatsapp_message_received_immediate', function(data) {
                        console.log("WhatsApp message received immediate via socket.io:", data);
                        processWhatsAppMessage(data);
                    });
                });

                socket.on('disconnect', function() {
                    console.log("Socket.io disconnected");
                });

                socket.on('reconnect', function() {
                    console.log("Socket.io reconnected");
                });

                socket.on('error', function(err) {
                    console.error("Socket.io error:", err);
                });

                // Store the socket in the window object for later use
                window.whatsappSocket = socket;
            } catch (e) {
                console.error("Error setting up socket.io connection:", e);
            }
        }

        // Function to process WhatsApp messages
        function processWhatsAppMessage(data) {
            console.log("Processing WhatsApp message:", data);

            // Refresh the conversation if it's the active one
            if (window.activeConversation) {
                if ((data.direction === 'Incoming' && data.from_number === window.activeConversation.phone) ||
                    (data.direction === 'Outgoing' && data.to_number === window.activeConversation.phone)) {
                    console.log("Message is for active conversation, refreshing...");
                    loadConversation(window.activeConversation.phone, window.activeConversation.name);
                } else {
                    console.log("Message is not for active conversation, refreshing list...");
                    refreshConversations();
                }
            } else {
                console.log("No active conversation, refreshing list...");
                refreshConversations();
            }
        }

        // Function to initialize WhatsApp UI
        function initializeWhatsAppUI() {
            console.log("Initializing WhatsApp UI...");

            // Set up initial conversation
            if (typeof initialConversationData !== 'undefined' && initialConversationData) {
                window.activeConversation = initialConversationData;
                console.log("Initial active conversation:", window.activeConversation);

                // Load the conversation
                loadConversation(window.activeConversation.phone, window.activeConversation.name);
            }

            // Set up event handlers
            setupEventHandlers();

            // Initial load of conversations
            refreshConversations();
        }

        // Set up initial conversation data if available
        {% if active_conversation %}
        var initialConversationData = {
            phone: "{{ active_conversation.phone }}",
            name: "{{ active_conversation.name }}"
        };
        {% endif %}

        // Set CSRF token
        var csrfToken = "{{ csrf_token }}";

        // Function to set up event handlers
        function setupEventHandlers() {
            console.log("Setting up event handlers...");

            // Set up conversation click handlers
            setupConversationClickHandlers();

            // Set up send message handler
            const sendBtn = document.querySelector('#send-message-btn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    const msgInput = document.querySelector('#message-input');
                    if (msgInput && msgInput.value.trim()) {
                        sendMessage(msgInput.value.trim());
                        msgInput.value = '';
                    }
                });
            }

            // Set up form submit handler
            const chatForm = document.querySelector('.chat-input');
            if (chatForm) {
                chatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const msgInput = document.querySelector('#message-input');
                    if (msgInput && msgInput.value.trim()) {
                        sendMessage(msgInput.value.trim());
                        msgInput.value = '';
                    }
                    return false;
                });
            }

            // Set up refresh button
            const refreshBtn = document.querySelector('#refresh-conversations-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    refreshConversations();
                });
            }

            // Set up back button for mobile
            const backBtn = document.querySelector('#back-to-conversations-btn');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    const whatsappGrid = document.querySelector('.whatsapp-grid');
                    if (whatsappGrid) {
                        whatsappGrid.classList.remove('show-chat');
                    }
                });
            }

            // Set up new conversation button
            const newConversationBtn = document.querySelector('#new-conversation-btn');
            if (newConversationBtn) {
                newConversationBtn.addEventListener('click', function() {
                    showNewConversationModal();
                });
            }
        }

        // Function to set up conversation click handlers
        function setupConversationClickHandlers() {
            const conversationItems = document.querySelectorAll('.conversation-item');
            conversationItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    const phone = this.dataset.phone;
                    const name = this.dataset.name;

                    // Remove active class from all items
                    conversationItems.forEach(function(item) {
                        item.classList.remove('active');
                    });

                    // Add active class to clicked item
                    this.classList.add('active');

                    // Load the conversation
                    loadConversation(phone, name);
                });
            });
        }

        // Function to load a conversation
        function loadConversation(phone, name) {
            console.log("Loading conversation:", phone, name);

            // Set active conversation
            window.activeConversation = {
                phone: phone,
                name: name
            };

            // Update UI
            const chatNameEl = document.querySelector('.chat-name');
            const chatStatusEl = document.querySelector('.chat-status');

            if (chatNameEl) {
                chatNameEl.textContent = name;
            }

            if (chatStatusEl) {
                chatStatusEl.textContent = 'Loading...';
            }

            // Show chat on mobile
            const whatsappGrid = document.querySelector('.whatsapp-grid');
            if (whatsappGrid) {
                whatsappGrid.classList.add('show-chat');
            }

            // Fetch messages
            fetchMessages(phone);
        }

        // Function to fetch messages
        function fetchMessages(phone) {
            console.log("Fetching messages for:", phone);

            // Use AJAX to fetch messages
            $.ajax({
                url: '/api/method/on_desk.www.on-desk.whatsapp.api.get_conversation_messages',
                type: 'POST',
                data: {
                    phone_number: phone
                },
                headers: {
                    'X-Frappe-CSRF-Token': csrfToken
                },
                success: function(response) {
                    console.log("Messages fetched:", response);

                    if (response.message) {
                        renderMessages(response.message);

                        // Update status
                        const chatStatusEl = document.querySelector('.chat-status');
                        if (chatStatusEl) {
                            chatStatusEl.textContent = 'Online';
                        }
                    } else {
                        console.error("No messages returned");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching messages:", error);

                    // Update status
                    const chatStatusEl = document.querySelector('.chat-status');
                    if (chatStatusEl) {
                        chatStatusEl.textContent = 'Error loading messages';
                    }
                }
            });
        }

        // Function to render messages
        function renderMessages(messages) {
            console.log("Rendering messages:", messages);

            const messagesContainer = document.querySelector('.chat-messages');
            if (!messagesContainer) {
                console.error("Messages container not found");
                return;
            }

            // Clear the container
            messagesContainer.innerHTML = '';

            // If no messages, show empty state
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="uil uil-comment-alt-message"></i>
                        </div>
                        <div class="empty-state-title">No messages yet</div>
                        <div class="empty-state-text">Start the conversation by sending a message</div>
                    </div>
                `;
                return;
            }

            // Add date divider
            const dateDivider = document.createElement('div');
            dateDivider.className = 'date-divider';
            dateDivider.textContent = 'Today';
            messagesContainer.appendChild(dateDivider);

            // Add messages
            messages.forEach(function(message) {
                const messageEl = document.createElement('div');
                messageEl.className = 'message ' + (message.direction === 'Incoming' ? 'message-incoming' : 'message-outgoing');
                messageEl.dataset.messageId = message.message_id;

                let messageContent = `
                    ${message.message}
                    <div class="message-time">${message.time}</div>
                `;

                if (message.direction === 'Outgoing') {
                    let statusIcon = '';
                    let statusClass = '';

                    if (message.status === 'Sent') {
                        statusIcon = 'uil-check';
                        statusClass = 'status-sent';
                    } else if (message.status === 'Delivered') {
                        statusIcon = 'uil-check-double';
                        statusClass = 'status-delivered';
                    } else if (message.status === 'Read') {
                        statusIcon = 'uil-check-double';
                        statusClass = 'status-read';
                    } else if (message.status === 'Failed') {
                        statusIcon = 'uil-times';
                        statusClass = 'status-failed';
                    }

                    messageContent += `
                        <div class="message-status">
                            <span>${message.status}</span>
                            <i class="uil ${statusIcon} status-icon ${statusClass}"></i>
                        </div>
                    `;
                }

                messageEl.innerHTML = messageContent;
                messagesContainer.appendChild(messageEl);
            });

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Function to send a message
        function sendMessage(message) {
            console.log("Sending message:", message);

            if (!window.activeConversation) {
                console.error("No active conversation");
                return;
            }

            // Disable the send button
            const sendBtn = document.querySelector('#send-message-btn');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="uil uil-spinner-alt fa-spin"></i>';
            }

            // Add temporary message to UI
            const messagesContainer = document.querySelector('.chat-messages');
            if (messagesContainer) {
                const tempId = 'temp-' + Date.now();
                const messageEl = document.createElement('div');
                messageEl.className = 'message message-outgoing';
                messageEl.dataset.messageId = tempId;
                messageEl.innerHTML = `
                    ${message}
                    <div class="message-time">Just now</div>
                    <div class="message-status">
                        <span>Sending...</span>
                        <i class="uil uil-spinner-alt fa-spin status-icon"></i>
                    </div>
                `;

                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Send the message via API
            $.ajax({
                url: '/api/method/on_desk.www.on-desk.whatsapp.api.send_message',
                type: 'POST',
                data: {
                    phone_number: window.activeConversation.phone,
                    message: message
                },
                headers: {
                    'X-Frappe-CSRF-Token': csrfToken
                },
                success: function(response) {
                    console.log("Message sent:", response);

                    // Update the temporary message
                    const tempMessage = document.querySelector(`[data-message-id="temp-${Date.now()}"]`);
                    if (tempMessage) {
                        tempMessage.dataset.messageId = response.message.message_id || tempId;
                        tempMessage.querySelector('.message-status').innerHTML = `
                            <span>Sent</span>
                            <i class="uil uil-check status-icon status-sent"></i>
                        `;
                    }

                    // Re-enable the send button
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="uil uil-message"></i>';
                    }

                    // Refresh the conversation
                    setTimeout(function() {
                        loadConversation(window.activeConversation.phone, window.activeConversation.name);
                    }, 1000);
                },
                error: function(xhr, status, error) {
                    console.error("Error sending message:", error);

                    // Update the temporary message
                    const tempMessage = document.querySelector(`[data-message-id="temp-${Date.now()}"]`);
                    if (tempMessage) {
                        tempMessage.querySelector('.message-status').innerHTML = `
                            <span>Failed</span>
                            <i class="uil uil-times status-icon status-failed"></i>
                        `;
                    }

                    // Re-enable the send button
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="uil uil-message"></i>';
                    }
                }
            });
        }

        // Function to refresh conversations
        function refreshConversations() {
            console.log("Refreshing conversations...");

            // Show loading state
            const conversationsList = document.querySelector('.conversation-list');
            if (conversationsList) {
                conversationsList.innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-muted"><i class="uil uil-spinner-alt fa-spin"></i> Loading conversations...</p>
                    </div>
                `;
            }

            // Fetch conversations
            $.ajax({
                url: '/api/method/on_desk.www.on-desk.whatsapp.api.get_conversations',
                type: 'GET',
                headers: {
                    'X-Frappe-CSRF-Token': csrfToken
                },
                success: function(response) {
                    console.log("Conversations fetched:", response);

                    if (response.message) {
                        renderConversations(response.message);
                    } else {
                        console.error("No conversations returned");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching conversations:", error);

                    if (conversationsList) {
                        conversationsList.innerHTML = `
                            <div class="text-center p-3">
                                <p class="text-danger">Error loading conversations</p>
                                <button class="btn btn-sm btn-primary" onclick="refreshConversations()">
                                    <i class="uil uil-refresh"></i> Try Again
                                </button>
                            </div>
                        `;
                    }
                }
            });
        }

        // Function to render conversations
        function renderConversations(conversations) {
            console.log("Rendering conversations:", conversations);

            const conversationsList = document.querySelector('.conversation-list');
            if (!conversationsList) {
                console.error("Conversations list not found");
                return;
            }

            // Clear the list
            conversationsList.innerHTML = '';

            // If no conversations, show empty state
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-muted">No conversations yet</p>
                        <button class="btn btn-sm btn-primary" id="new-conversation-btn">
                            <i class="uil uil-plus"></i> New Conversation
                        </button>
                    </div>
                `;

                // Set up new conversation button
                const newConversationBtn = document.querySelector('#new-conversation-btn');
                if (newConversationBtn) {
                    newConversationBtn.addEventListener('click', function() {
                        showNewConversationModal();
                    });
                }

                return;
            }

            // Add conversations
            conversations.forEach(function(conversation) {
                const conversationItem = document.createElement('li');
                conversationItem.className = 'conversation-item';
                conversationItem.dataset.phone = conversation.phone;
                conversationItem.dataset.name = conversation.name;

                // Add active class if this is the active conversation
                if (window.activeConversation && window.activeConversation.phone === conversation.phone) {
                    conversationItem.classList.add('active');
                }

                conversationItem.innerHTML = `
                    <div class="conversation-avatar">
                        ${conversation.name.charAt(0)}
                        ${conversation.status === 'Online' ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-name">${conversation.name}</div>
                        <div class="conversation-preview">${conversation.last_message || 'No messages yet'}</div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${conversation.time || ''}</div>
                        ${conversation.unread ? '<div class="unread-badge">' + conversation.unread + '</div>' : ''}
                    </div>
                `;

                conversationsList.appendChild(conversationItem);
            });

            // Set up conversation click handlers
            setupConversationClickHandlers();
        }

        // Function to show new conversation modal
        function showNewConversationModal() {
            console.log("Showing new conversation modal...");

            // Create modal if it doesn't exist
            let modal = document.querySelector('#new-conversation-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'new-conversation-modal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">New Conversation</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="new-conversation-phone" class="form-label">Phone Number</label>
                                    <input type="text" class="form-control" id="new-conversation-phone" placeholder="e.g. 255789968024">
                                    <div class="form-text">Enter the phone number with country code, without + or spaces</div>
                                </div>
                                <div class="mb-3">
                                    <label for="new-conversation-name" class="form-label">Contact Name</label>
                                    <input type="text" class="form-control" id="new-conversation-name" placeholder="e.g. John Doe">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="create-conversation-btn">Create</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Set up create button
                const createBtn = document.querySelector('#create-conversation-btn');
                if (createBtn) {
                    createBtn.addEventListener('click', function() {
                        const phone = document.querySelector('#new-conversation-phone').value;
                        const name = document.querySelector('#new-conversation-name').value;

                        if (!phone) {
                            alert('Please enter a phone number');
                            return;
                        }

                        if (!name) {
                            alert('Please enter a contact name');
                            return;
                        }

                        createNewConversation(phone, name);
                    });
                }
            }

            // Show the modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        // Function to create a new conversation
        function createNewConversation(phone, name) {
            console.log("Creating new conversation:", phone, name);

            // Call the API to create a new conversation
            $.ajax({
                url: '/api/method/on_desk.www.on-desk.whatsapp.api.create_conversation',
                type: 'POST',
                data: {
                    phone_number: phone,
                    contact_name: name
                },
                headers: {
                    'X-Frappe-CSRF-Token': csrfToken
                },
                success: function(response) {
                    console.log("Conversation created:", response);

                    // Hide the modal
                    const modal = document.querySelector('#new-conversation-modal');
                    if (modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                        }
                    }

                    // Refresh conversations
                    refreshConversations();

                    // Load the new conversation
                    loadConversation(phone, name);
                },
                error: function(xhr, status, error) {
                    console.error("Error creating conversation:", error);
                    alert('Error creating conversation: ' + error);
                }
            });
        }
    });
</script>
{% endblock %}
