<!-- Common Scripts -->
<script src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>

<!-- Load Frappe core libraries properly -->
<script>
    // Load Frappe in a proper sequence
    document.addEventListener('DOMContentLoaded', function () {
        // Function to check if frappe is fully initialized
        function isFrappeFullyInitialized() {
            // Check if frappe exists and has the methods we need
            if (typeof frappe === 'undefined') return false;

            // Check if frappe.call exists and is a real function (not our temporary one)
            if (typeof frappe.call !== 'function') return false;

            // Check if frappe.require exists and is a real function (not our temporary one)
            if (typeof frappe.require !== 'function') return false;

            // Additional check: if we have our temporary frappe object, it won't have these properties
            if (!frappe._assets_loaded && !frappe.assets) return false;

            return true;
        }

        // Function to dispatch the frappe_loaded event
        function dispatchFrappeLoaded() {
            console.log('Dispatching frappe_loaded event');
            document.dispatchEvent(new Event('frappe_loaded'));
        }

        // First check if frappe is already fully defined
        if (isFrappeFullyInitialized()) {
            console.log('Frappe is already fully initialized');
            dispatchFrappeLoaded();
            return;
        }

        // If frappe exists but is not fully initialized
        if (typeof frappe !== 'undefined') {
            console.log('Frappe exists but may not be fully initialized, waiting...');

            // Try loading frappe-web.min.js to ensure all methods are available
            var webScript = document.createElement('script');
            webScript.src = '/assets/js/frappe-web.min.js';
            webScript.onload = function () {
                console.log('Frappe web bundle loaded');

                // Check again after a short delay to allow initialization
                setTimeout(function () {
                    if (isFrappeFullyInitialized()) {
                        console.log('Frappe is now fully initialized');
                    } else {
                        console.log('Frappe still not fully initialized after loading web bundle');
                    }
                    dispatchFrappeLoaded();
                }, 300);
            };
            document.head.appendChild(webScript);
            return;
        }

        // If frappe doesn't exist at all
        console.log('Loading Frappe core libraries from scratch...');

        // Create a script element to load provide.js first
        var provideScript = document.createElement('script');
        provideScript.src = '/assets/frappe/js/frappe/provide.js';
        provideScript.onload = function () {
            console.log('Frappe provide.js loaded');

            // Now load the main frappe-web bundle
            var webScript = document.createElement('script');
            webScript.src = '/assets/js/frappe-web.min.js';
            webScript.onload = function () {
                console.log('Frappe web bundle loaded');

                // Check if frappe is fully initialized after a short delay
                setTimeout(function () {
                    if (isFrappeFullyInitialized()) {
                        console.log('Frappe is fully initialized after loading');
                    } else {
                        console.log('Frappe not fully initialized after loading, proceeding anyway');
                    }
                    dispatchFrappeLoaded();
                }, 300);
            };
            document.head.appendChild(webScript);
        };
        document.head.appendChild(provideScript);
    });

    // Define a temporary frappe object for use before the real one loads
    if (typeof frappe === 'undefined') {
        console.warn('Creating temporary frappe object');
        window.frappe = {
            // Add a flag to identify this as our temporary object
            _isTemporaryFrappe: true,

            call: function (opts) {
                console.log('TEMP FRAPPE: Queuing API call:', opts);
                // Queue the call to be executed when frappe is loaded
                document.addEventListener('frappe_loaded', function () {
                    if (typeof frappe.call === 'function' && !frappe._isTemporaryFrappe) {
                        console.log('TEMP FRAPPE: Executing queued API call with real frappe');
                        frappe.call(opts);
                    } else {
                        console.error('TEMP FRAPPE: Real frappe not available for queued call');
                        if (opts.error) {
                            opts.error(new Error('Real frappe call method not available'));
                        }
                    }
                }, { once: true });
            },

            msgprint: function (opts) {
                console.log('TEMP FRAPPE: Queuing message:', opts);
                // Show a basic alert for now
                alert(opts.message || 'An error occurred');
            },

            require: function (assets, callback) {
                console.log('TEMP FRAPPE: Queuing require for:', assets);
                // Queue the require to be executed when frappe is loaded
                document.addEventListener('frappe_loaded', function () {
                    if (typeof frappe.require === 'function' && !frappe._isTemporaryFrappe) {
                        console.log('TEMP FRAPPE: Executing queued require with real frappe');
                        frappe.require(assets, callback);
                    } else {
                        console.log('TEMP FRAPPE: Real frappe.require not available, loading scripts directly');
                        // Try to load scripts manually
                        if (typeof assets === 'string') {
                            assets = [assets];
                        }
                        var loaded = 0;
                        assets.forEach(function (asset) {
                            var script = document.createElement('script');
                            script.src = asset.startsWith('/') ? asset : '/assets/js/' + asset;
                            script.onload = function () {
                                loaded++;
                                if (loaded === assets.length && callback) {
                                    callback();
                                }
                            };
                            document.head.appendChild(script);
                        });
                    }
                }, { once: true });
            }
        };
    }

    // Define __ function if it doesn't exist
    if (typeof __ !== 'function') {
        window.__ = function (txt) {
            return txt;
        };
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mobile Sidebar Toggle
        const toggleSidebar = () => {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            sidebar.classList.toggle('show');

            if (!overlay) {
                const newOverlay = document.createElement('div');
                newOverlay.classList.add('sidebar-overlay');
                newOverlay.classList.add('show');
                newOverlay.addEventListener('click', toggleSidebar);
                document.body.appendChild(newOverlay);
            } else {
                overlay.classList.toggle('show');
            }
        };

        // Add mobile menu button if needed
        if (window.innerWidth <= 768) {
            const header = document.querySelector('.header');
            const menuBtn = document.createElement('button');
            menuBtn.classList.add('mobile-menu-btn');
            menuBtn.innerHTML = '<i class="uil uil-bars"></i>';
            menuBtn.style.marginRight = 'auto';
            menuBtn.addEventListener('click', toggleSidebar);

            header.insertBefore(menuBtn, header.firstChild);

            // Add styles for the mobile menu button
            const style = document.createElement('style');
            style.textContent = `
                .mobile-menu-btn {
                    background: transparent;
                    border: none;
                    color: #e2e8f0;
                    font-size: 1.25rem;
                    cursor: pointer;
                    padding: 0.5rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 0.5rem;
                }

                .mobile-menu-btn i {
                    font-size: 1.5rem;
                }
            `;
            document.head.appendChild(style);
        }

        // Handle logout links
        const logoutLinks = document.querySelectorAll('a[href="/logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();

                // Show loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="uil uil-spinner-alt fa-spin"></i> Logging out...';
                this.style.pointerEvents = 'none';

                // Set a timeout to redirect to /logout directly if the AJAX call takes too long
                const logoutTimeout = setTimeout(() => {
                    console.log('Logout AJAX call timeout, redirecting to /logout directly');
                    window.location.href = '/logout';
                }, 3000); // 3 seconds timeout

                // Prepare headers
                const headers = {
                    'Accept': 'application/json'
                };

                // Add CSRF token if available
                if (window.frappe && frappe.csrf_token) {
                    headers['X-Frappe-CSRF-Token'] = frappe.csrf_token;
                }

                // Make AJAX call to logout endpoint
                fetch('/api/method/logout', {
                    method: 'GET',
                    credentials: 'include',
                    headers: headers
                })
                    .then(response => {
                        // Clear the timeout since we got a response
                        clearTimeout(logoutTimeout);

                        if (response.ok) {
                            // Redirect to login page
                            window.location.href = '/login';
                        } else {
                            // If there's an error, still try to redirect
                            console.error('Logout failed, redirecting anyway');
                            window.location.href = '/login';
                        }
                    })
                    .catch(error => {
                        // Clear the timeout
                        clearTimeout(logoutTimeout);

                        console.error('Error during logout:', error);
                        // Even if there's an error, redirect to login
                        window.location.href = '/login';
                    });
            });
        });
    });
</script>

<!-- Page-specific Scripts -->
{% block page_js %}{% endblock %}